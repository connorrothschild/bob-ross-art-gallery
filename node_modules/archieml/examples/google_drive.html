<!DOCTYPE html>
<html>
  <head>
    <script src="https://apis.google.com/js/client.js"></script>
    <script src="../archieml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20140204/json2.js"></script>
    <script>
      function auth(callback) {
        var config = {
          'client_id': '383236636876-20uldt3a6ikag8fsvpmht779ocdart0l.apps.googleusercontent.com',
          'scope': 'https://www.googleapis.com/auth/drive'
        };
        gapi.auth.authorize(config, function() {
          console.log('login complete');
          console.log(gapi.auth.getToken());

          gapi.client.load('drive', 'v2', function() {
            callback();
          });

        });
      }

      // This ensure we are authenticated, and then fetches the document's metadata.
      function fetch() {
        auth(function() {
          var request = gapi.client.drive.files.get({
            'fileId': document.getElementById('key').value
          });
          request.execute(function(resp) {
            if (!resp.error) {
              console.log('Title: ' + resp.title);
              console.log('Description: ' + resp.description);
              console.log('MIME type: ' + resp.mimeType);

              download(resp);
            } else if (resp.error.code == 401) {
              // Access token might have expired.
              checkAuth();
            } else {
              console.log('An error occured: ' + resp.error.message);
            }
          });
        });
      }

      // `resp` is the document's metadata. This function loads either the
      // HTML or Text version of the document, and runs it through the
      // ArchieML parser.
      //
      // There are the URLs for two versions of the exported document body:
      // plain text which is fine for simple parsing, and html which is
      // useful if we want to preserve links in the source document (see the
      // convertHtmlToText function below).
      function download(resp) {
        var format = document.getElementById('text').checked ? "text/plain" : "text/html";
        console.log("format selected:", format);
        var export_link = resp.exportLinks[format];
        console.log(export_link);

        var accessToken = gapi.auth.getToken().access_token;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', export_link);
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.onload = function() {
          // We now have the body of the selected format.
          // We should convert the html back to text if we selected HTML
          // Then, run the document through the parser, and insert it into the
          // textarea.
          var body = xhr.responseText;
          if (format == "text/html") {
            body = convertHtmlToText(body);
          }
          var parsed = archieml.load(body);

          document.getElementById('output').value = JSON.stringify(parsed, null, 2);
        };
        xhr.onerror = function() {
          console.log('error');
        };
        xhr.send();
      }

      // There are a few extra steps that we do to make working with Google
      // Documents more useful. With a little more prep, we generally process
      // the documents to:
      //
      //   * Include links that users enter in the google document as HTML
      //     `<a>` tags
      //   * Remove smart quotes inside tag brackets `<>` (which Google loves
      //     to add for you)
      //   * Ensure that list bullet points are turned into `*`s
      //
      // Unfortunately, google strips out links when you export as `text/plain`,
      // so if you want to preserve them, we have to export the document in a
      // different format, `text/html`.
      function convertHtmlToText(body) {
        // TK
      }

    </script>
  </head>

  <body>
    <input id="text" type="radio" name="format" checked> Text
    <input id="html" type="radio" name="format"> HTML
    <br>
    <input id="key" type="text" placeholder="Google Doc Key" value="1JjYD90DyoaBuRYNxa4_nqrHKkgZf1HrUj30i3rTWX1s">
    <input type="submit" value="Submit" onclick="fetch();">
    <br>
    <textarea id="output" rows="20" cols="100"></textarea>
  </body>
</html>

